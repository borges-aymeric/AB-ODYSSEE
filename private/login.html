<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AB Odyssée - Connexion Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="css/main.css">
</head>
<body class="min-h-screen bg-[#FCF9EF] flex items-center justify-center">
  <div class="w-full max-w-md px-6">
    <div class="bg-white border border-[#B6B4AC]/20 rounded-2xl shadow-xl p-8 md:p-10">
      <div class="text-center mb-8">
        <img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/690e092a150929816e34c705/79e4f2ccc_image.png" 
             alt="AB Odyssée Logo" 
             class="h-16 w-auto mx-auto mb-4 rounded-md"/>
        <h1 class="text-3xl md:text-4xl font-bold text-[#091A30] mb-2">Connexion Admin</h1>
        <p class="text-sm text-[#616972]">Accès réservé aux administrateurs</p>
      </div>

      <form id="login-form" class="space-y-6">
        <div>
          <label for="username" class="block text-sm font-medium text-[#091A30] mb-2">
            Nom d'utilisateur
          </label>
          <input type="text" 
                 id="username" 
                 name="username" 
                 required 
                 autocomplete="username"
                 class="w-full px-4 py-3 bg-white border border-[#B6B4AC]/30 rounded-md shadow-sm text-[#091A30] placeholder-[#616972] focus:ring-2 focus:ring-[#B48A3C] focus:border-[#B48A3C] transition-colors"
                 placeholder="Nom d'utilisateur">
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-[#091A30] mb-2">
            Mot de passe
          </label>
          <div class="relative">
            <input type="password" 
                   id="password" 
                   name="password" 
                   required 
                   autocomplete="current-password"
                   class="w-full px-4 py-3 bg-white border border-[#B6B4AC]/30 rounded-md shadow-sm text-[#091A30] placeholder-[#616972] focus:ring-2 focus:ring-[#B48A3C] focus:border-[#B48A3C] transition-colors pr-12"
                   placeholder="Mot de passe">
            <button type="button" 
                    id="toggle-password" 
                    class="absolute right-3 top-1/2 -translate-y-1/2 text-[#616972] hover:text-[#091A30] transition-colors"
                    aria-label="Afficher/Masquer le mot de passe">
              <i data-lucide="eye" class="w-5 h-5" id="eye-icon"></i>
            </button>
          </div>
        </div>

        <div id="message-container" class="hidden p-4 rounded-md"></div>

        <button type="submit" 
                id="login-button"
                class="w-full inline-flex items-center justify-center bg-[#B48A3C] hover:bg-[#9A7332] text-white font-semibold px-8 py-3 text-lg rounded-md transition-colors shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed">
          <i data-lucide="log-in" class="w-5 h-5 mr-2"></i>
          <span id="button-text">Se connecter</span>
        </button>
      </form>

      <div class="mt-6 text-center">
        <a href="index.html" 
           class="text-sm text-[#616972] hover:text-[#091A30] transition-colors">
          ← Retour à l'accueil
        </a>
      </div>
    </div>

    <div class="mt-6 text-center text-xs text-[#616972]">
      <p>© 2024 AB Odyssée. Tous droits réservés.</p>
    </div>
  </div>

  <script>
    lucide.createIcons();

    const form = document.getElementById('login-form');
    const messageContainer = document.getElementById('message-container');
    const loginButton = document.getElementById('login-button');
    const buttonText = document.getElementById('button-text');
    const togglePassword = document.getElementById('toggle-password');
    const passwordInput = document.getElementById('password');
    const eyeIcon = document.getElementById('eye-icon');

    let passwordVisible = false;

    // Fonction pour échapper le HTML et prévenir XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Validation côté client
    function validateInput(username, password) {
      if (!username || username.trim().length === 0) {
        return { valid: false, error: 'Le nom d\'utilisateur est requis.' };
      }
      if (username.length > 100) {
        return { valid: false, error: 'Le nom d\'utilisateur est trop long.' };
      }
      if (!password || password.length === 0) {
        return { valid: false, error: 'Le mot de passe est requis.' };
      }
      if (password.length > 200) {
        return { valid: false, error: 'Le mot de passe est trop long.' };
      }
      // Validation de caractères autorisés
      if (!/^[a-zA-Z0-9_@.-]+$/.test(username)) {
        return { valid: false, error: 'Le nom d\'utilisateur contient des caractères invalides.' };
      }
      return { valid: true };
    }

    // Toggle password visibility
    togglePassword.addEventListener('click', () => {
      passwordVisible = !passwordVisible;
      passwordInput.type = passwordVisible ? 'text' : 'password';
      
      // Changer l'icône
      eyeIcon.setAttribute('data-lucide', passwordVisible ? 'eye-off' : 'eye');
      lucide.createIcons();
    });

    // Vérifier si déjà connecté
    async function checkAuthStatus() {
      try {
        const apiUrl = window.location.origin + '/api/auth/status';
        const response = await fetch(apiUrl, {
          credentials: 'include'
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.authenticated) {
            // Rediriger vers le CRM si déjà connecté
            window.location.href = 'admin-crm.html';
          }
        }
      } catch (error) {
        // Ne pas afficher d'erreurs détaillées en production
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.error('Erreur lors de la vérification:', error);
        }
      }
    }

    checkAuthStatus();

    // Soumission du formulaire
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;

      // Validation côté client
      const validation = validateInput(username, password);
      if (!validation.valid) {
        messageContainer.classList.remove('hidden');
        messageContainer.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-400');
        messageContainer.innerHTML = '';
        const errorDiv = document.createElement('div');
        errorDiv.className = 'flex items-center gap-2';
        errorDiv.innerHTML = '<i data-lucide="alert-circle" class="w-5 h-5"></i><span>' + escapeHtml(validation.error) + '</span>';
        messageContainer.appendChild(errorDiv);
        lucide.createIcons();
        return;
      }

      // Désactiver le bouton pendant la requête
      loginButton.disabled = true;
      buttonText.textContent = 'Connexion...';
      
      // Masquer les messages précédents
      messageContainer.classList.add('hidden');

      try {
        // Utiliser window.location.origin au lieu d'URL codée en dur
        const apiUrl = window.location.origin + '/api/auth/login';
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest' // Protection contre certains types d'attaques
          },
          credentials: 'include', // Important pour les sessions
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        messageContainer.classList.remove('hidden');
        messageContainer.className = 'p-4 rounded-md';

        if (response.ok) {
          messageContainer.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-400');
          // Utiliser textContent au lieu de innerHTML pour éviter XSS
          messageContainer.innerHTML = '';
          const successDiv = document.createElement('div');
          successDiv.className = 'flex items-center gap-2';
          successDiv.innerHTML = '<i data-lucide="check-circle" class="w-5 h-5"></i><span>Connexion réussie.</span>';
          messageContainer.appendChild(successDiv);
          lucide.createIcons();
          
          // Rediriger vers le CRM après succès
          setTimeout(() => {
            window.location.href = 'admin-crm.html';
          }, 1000);
        } else {
          messageContainer.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-400');
          // Utiliser textContent pour éviter XSS - ne pas afficher directement data.error
          messageContainer.innerHTML = '';
          const errorDiv = document.createElement('div');
          errorDiv.className = 'flex items-center gap-2';
          const errorText = data.error && typeof data.error === 'string' && data.error.length < 200 
            ? escapeHtml(data.error) 
            : 'Identifiants incorrects.';
          errorDiv.innerHTML = '<i data-lucide="alert-circle" class="w-5 h-5"></i><span>' + errorText + '</span>';
          messageContainer.appendChild(errorDiv);
          lucide.createIcons();
          
          // Réactiver le bouton
          loginButton.disabled = false;
          buttonText.textContent = 'Se connecter';
        }
      } catch (error) {
        messageContainer.classList.remove('hidden');
        messageContainer.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-400');
        messageContainer.innerHTML = '';
        const errorDiv = document.createElement('div');
        errorDiv.className = 'flex items-center gap-2';
        errorDiv.innerHTML = '<i data-lucide="alert-circle" class="w-5 h-5"></i><span>Erreur de connexion au serveur.</span>';
        messageContainer.appendChild(errorDiv);
        lucide.createIcons();
        
        // Réactiver le bouton
        loginButton.disabled = false;
        buttonText.textContent = 'Se connecter';
        
        // Ne pas logger les erreurs sensibles en production
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.error('Erreur:', error);
        }
      }
    });
  </script>
</body>
</html>

